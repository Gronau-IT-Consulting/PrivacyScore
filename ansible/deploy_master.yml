- hosts: all
  become: true
  become_user: root
  vars:
    ansible_ssh_pipelining: yes
    apt_file: /etc/apt/sources.list.d/google-chrome.list
  tasks:
    - name: Install apt packages
      apt: 
        name: "{{ packages }}"
      vars:
        packages:
          - build-essential
          - git
          - libboost-python-dev
          - libffi-dev
          - libjpeg-dev
          - libleveldb1v5  # v5 on stretch
          - libleveldb-dev
          - libpq-dev
          - libre2-dev
          - libssl-dev
          - libxml2-dev
          - libxslt-dev
          - ntp
          - python3
          - python3-dev
          - python3-six
          - python-dev
          - sudo
          - virtualenv
          - xvfb
          - python-setuptools
    - name: Does the Google apt file exist?
      command: test -f {{apt_file}}
      register: google_apt_exists
      ignore_errors: True
    - name: Add Google Chrome key
      shell: wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
      when: google_apt_exists.rc == 1
    - name: Add Google Chrome repo
      copy: content="deb http://dl.google.com/linux/chrome/deb/ stable main" dest={{apt_file}} owner=root group=root mode=644
      when: google_apt_exists.rc == 1
    - name: Update apt cache
      apt: update_cache=yes
      when: google_apt_exists.rc == 1
    - name: Install Google Chrome
      apt: pkg=google-chrome-stable state=installed
    - name: Enable NTP service
      service:
        name: ntp
        state: started
        enabled: yes
    - name: Create root .ssh directory
      file:
        path: /root/.ssh
        owner: root
        group: root
        mode: 0700
        state: directory
    - name: Store ssh key for root
      copy:
        src: id_rsa
        dest: /root/.ssh/id_rsa
        owner: root
        group: root
        mode: 0400
    - name: Clone privacyscore git repository
      git:
        repo: https://github.com/Gronau-IT-Consulting/PrivacyScore.git
        dest: /opt/privacyscore
        version: Teamevent-Tallinnn
        accept_hostkey: yes
    - name: Create privacyscore user
      user:
        name: privacyscore
        home: /opt/privacyscore
        shell: /bin/bash
        system: yes
    - name: Set owner of privacyscore directory
      file:
        path: /opt/privacyscore
        owner: privacyscore
        group: privacyscore
        recurse: yes
    - name: Prepare privacyscore user
      become: yes
      become_user: privacyscore
      args:
        creates: /opt/privacyscore/.bashrc
      shell: |
        set -e

        cd /opt/privacyscore

        virtualenv --python $(which python3) .pyenv

        cp /etc/skel/.bashrc .
        echo ". /opt/privacyscore/.pyenv/bin/activate" >> .bashrc
        ln -sf .bashrc .bash_profile

        . /opt/privacyscore/.pyenv/bin/activate

        pip install six
        pip install -r requirements.txt
        pip install typing

        ./install-tests.sh
    - name: Place settings
      template:
        src: templates/settings.py
        dest: /opt/privacyscore/privacyscore/settings.py
        owner: privacyscore
        group: privacyscore
        mode: 0500
    - name: Place systemd unit file for privacyscore-celery-master
      template:
        src: templates/privacyscore-celery-master.service
        dest: /etc/systemd/system/privacyscore-celery-master.service
    - name: Enable and start celery master service
      service:
        name: privacyscore-celery-master
        state: started
        enabled: yes
    - name: Create privacyscore .ssh directory
      file:
        path: /opt/privacyscore/.ssh
        owner: privacyscore
        group: privacyscore
        mode: 0700
        state: directory
    - name: Store ssh key for privacyscore
      copy:
        src: id_rsa
        dest: /opt/privacyscore/.ssh/id_rsa
        owner: privacyscore
        group: privacyscore
        mode: 0400
    - name: Pull git repository as privacyscore user to accept hostkey initially
      become: yes
      become_user: privacyscore
      git:
        repo: https://github.com/Gronau-IT-Consulting/PrivacyScore.git
        dest: /opt/privacyscore
        version: Teamevent-Tallinnn
        accept_hostkey: yes
    - name: Create Directory for static files
      become: yes
      file:
        path: /var/www/privacyscore.org
        state: directory
        mode: 0755
        owner: privacyscore
